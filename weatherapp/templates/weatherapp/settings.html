{% extends 'weatherapp/base.html' %}
{% load static %}
{% block title %}Settings - Climascope{% endblock %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="text-center mb-5">
                <h2 class="display-5 fw-bold mb-3 text-white"><i class="fas fa-cogs me-2"></i>Account Settings</h2>
                <p class="lead text-light">Manage your profile, preferences, and account security</p>
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Settings Navigation -->
            <div class="glass-card p-4 mb-4">
                <ul class="nav nav-pills nav-fill mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                            <i class="fas fa-user me-2"></i>Profile Settings
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                            <i class="fas fa-shield-alt me-2"></i>Security
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab" aria-controls="notifications" aria-selected="false">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">
                            <i class="fas fa-cog me-2"></i>Account
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="settingsTabsContent">
                    <!-- Profile Settings Tab -->
                    <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <div class="row">
                            <div class="col-md-4 text-center mb-4">
                                <div class="avatar-container position-relative d-inline-block mb-4">
                                    {% if profile.avatar %}
                                        <div class="avatar-frame">
                                            <img src="{{ profile.avatar.url }}" alt="Avatar" class="rounded-circle" 
                                                 width="180" height="180" style="object-fit: cover;">
                                        </div>
                                    {% else %}
                                        <div class="avatar-frame">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 180px; height: 180px;">
                                                <i class="fas fa-user text-white" style="font-size: 5rem;"></i>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <div class="online-indicator"></div>
                                </div>
                                
                                <!-- Email Verification Status -->
                                {% if not profile.is_email_verified %}
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Email Not Verified</strong><br>
                                    <small>You won't receive alerts until verified.</small><br>
                                    <a href="{% url 'resend_verification' %}" class="btn btn-sm btn-warning mt-2">
                                        <i class="fas fa-envelope me-1"></i>Resend Verification
                                    </a>
                                </div>
                                {% else %}
                                <div class="alert alert-success mb-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Email Verified</strong>
                                </div>
                                {% endif %}
                                
                                <form method="POST" action="{% url 'profile' %}" enctype="multipart/form-data" class="d-inline">
                                    {% csrf_token %}
                                    <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;" onchange="this.form.submit()">
                                    <button type="button" class="btn btn-outline-light btn-sm" onclick="document.getElementById('avatarInput').click()">
                                        <i class="fas fa-camera me-1"></i> Change Avatar
                                    </button>
                                </form>
                                {% if profile.avatar %}
                                <form method="POST" action="{% url 'delete_avatar' %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm ms-1">
                                        <i class="fas fa-trash me-1"></i> Remove
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-8">
                                <form method="POST" action="{% url 'settings' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="profile-form" value="1">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="first_name" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="last_name" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}">
                                        <div class="form-text">Changing your email will require re-verification.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="location" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="location" name="location" value="{{ profile.location|default:'' }}" placeholder="Enter your location">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Profile Changes
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab (Integrated Password Change) -->
                    <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-4 text-white">
                                    <i class="fas fa-key me-2"></i>Change Password
                                </h5>
                                
                                <form method="POST" action="{% url 'settings' %}" id="passwordForm">
                                    {% csrf_token %}
                                    <input type="hidden" name="password-form" value="1">
                                    
                                    <div class="mb-3">
                                        <label for="{{ password_form.old_password.id_for_label }}" class="form-label">
                                            <i class="fas fa-lock me-2"></i>Current Password
                                        </label>
                                        {{ password_form.old_password }}
                                        {% if password_form.old_password.errors %}
                                            <div class="text-danger mt-1">
                                                {% for error in password_form.old_password.errors %}
                                                    <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="{{ password_form.new_password1.id_for_label }}" class="form-label">
                                            <i class="fas fa-key me-2"></i>New Password
                                        </label>
                                        {{ password_form.new_password1 }}
                                        <div class="strength-meter mt-2">
                                            <div class="strength-fill" id="strengthFill"></div>
                                        </div>
                                        <small class="form-text" id="strengthText">Password strength: Weak</small>
                                        {% if password_form.new_password1.errors %}
                                            <div class="text-danger mt-1">
                                                {% for error in password_form.new_password1.errors %}
                                                    <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="{{ password_form.new_password2.id_for_label }}" class="form-label">
                                            <i class="fas fa-check-double me-2"></i>Confirm New Password
                                        </label>
                                        {{ password_form.new_password2 }}
                                        {% if password_form.new_password2.errors %}
                                            <div class="text-danger mt-1">
                                                {% for error in password_form.new_password2.errors %}
                                                    <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save me-2"></i>Update Password
                                    </button>
                                </form>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="mb-4 text-white">
                                    <i class="fas fa-shield-alt me-2"></i>Security Information
                                </h5>
                                
                                <div class="security-info">
                                    <div class="info-card mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-check text-success me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Account Status</h6>
                                                <small class="text-muted">Active and Verified</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="info-card mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar text-info me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Member Since</h6>
                                                <small class="text-muted">{{ user.date_joined|date:"F d, Y" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="info-card mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-clock text-warning me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Last Login</h6>
                                                <small class="text-muted">{{ user.last_login|date:"F d, Y g:i A"|default:"Never" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="security-tips mt-4">
                                    <h6 class="text-white mb-3">
                                        <i class="fas fa-lightbulb me-2"></i>Security Tips
                                    </h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Use a strong, unique password
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Keep your email address current
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Log out on shared devices
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Review your account regularly
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
                        <h5 class="mb-4 text-white">
                            <i class="fas fa-bell me-2"></i>Email Notifications
                        </h5>
                        
                        <form method="POST" action="{% url 'settings' %}">
                            {% csrf_token %}
                            <input type="hidden" name="alert-settings" value="1">
                            
                            <div class="form-check form-switch mb-3 p-4 bg-light rounded">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" name="email_notifications" {% if profile.email_notifications %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="emailNotifications">
                                    Enable all email notifications
                                </label>
                                <div class="form-text">Receive all types of email notifications from Climascope</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3 p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="weatherAlerts" name="weather_alerts" {% if profile.weather_alerts %}checked{% endif %}>
                                        <label class="form-check-label" for="weatherAlerts">Weather Alerts</label>
                                        <div class="form-text">Get weather alerts for favorite cities</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3 p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="dailySummary" name="daily_summary" {% if profile.daily_summary %}checked{% endif %}>
                                        <label class="form-check-label" for="dailySummary">Daily Summary</label>
                                        <div class="form-text">Get daily weather summaries</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check form-switch mb-3 p-3 bg-light rounded">
                                <input class="form-check-input" type="checkbox" id="severeWeatherAlerts" name="severe_weather_alerts" {% if profile.severe_weather_alerts %}checked{% endif %}>
                                <label class="form-check-label" for="severeWeatherAlerts">Severe Weather Alerts</label>
                                <div class="form-text">Receive severe weather alerts</div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="fas fa-save me-2"></i>Save Notification Settings
                            </button>
                        </form>

                        <!-- Test Notifications Section -->
                        <div class="mt-5 p-4 bg-dark rounded">
                            <h5 class="text-white">
                                <i class="fas fa-vial me-2"></i>Test Notifications
                            </h5>
                            <p class="text-light">Test your notification settings to make sure everything is working.</p>
                            
                            <form method="POST" action="{% url 'test_notifications' %}">
                                {% csrf_token %}
                                <div class="btn-group-vertical d-grid gap-2 d-md-flex">
                                    <button type="submit" name="notification_type" value="daily_summary" class="btn btn-outline-info">
                                        <i class="fas fa-envelope me-2"></i>Test Daily Summary
                                    </button>
                                    <button type="submit" name="notification_type" value="weather_alert" class="btn btn-outline-warning">
                                        <i class="fas fa-bell me-2"></i>Test Weather Alert
                                    </button>
                                    <button type="submit" name="notification_type" value="welcome" class="btn btn-outline-success">
                                        <i class="fas fa-check me-2"></i>Test Welcome Email
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Account Management Tab -->
                    <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
                        <h5 class="mb-4 text-white">
                            <i class="fas fa-exclamation-triangle me-2"></i>Account Management
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-warning h-100">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-pause-circle text-warning mb-3" style="font-size: 3rem;"></i>
                                        <h5 class="card-title">Deactivate Account</h5>
                                        <p class="card-text">Temporarily disable your account. You can reactivate it anytime by logging in again.</p>
                                        <a href="{% url 'deactivate_account' %}" class="btn btn-warning">
                                            <i class="fas fa-pause-circle me-2"></i>Deactivate Account
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card border-danger h-100">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-trash-alt text-danger mb-3" style="font-size: 3rem;"></i>
                                        <h5 class="card-title">Delete Account</h5>
                                        <p class="card-text">Permanently delete your account and all associated data. This cannot be undone.</p>
                                        <a href="{% url 'delete_account' %}" class="btn btn-danger">
                                            <i class="fas fa-trash-alt me-2"></i>Delete Account Permanently
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Account deactivation is reversible, but deletion is permanent and cannot be undone. 
                            All your weather data, favorites, and settings will be permanently removed.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Enhanced styling for settings page */
    .glass-card {
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .nav-pills .nav-link {
        color: rgba(255,255,255,0.8);
        border-radius: 10px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #4dabf7 0%, #1b345e 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .tab-content {
        padding-top: 20px;
    }
    
    .avatar-frame {
        position: relative;
        display: inline-block;
        border-radius: 50%;
        padding: 8px;
        background: linear-gradient(135deg, #4dabf7 0%, #1b345e 100%);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .online-indicator {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 20px;
        height: 20px;
        background-color: #4CAF50;
        border: 3px solid white;
        border-radius: 50%;
    }
    
    .form-control, .form-select {
        background-color: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        border-radius: 10px;
        padding: 0.75rem 1rem;
    }
    
    .form-control::placeholder {
        color: rgba(255,255,255,0.7);
    }
    
    .form-control:focus, .form-select:focus {
        background-color: rgba(255,255,255,0.15);
        border-color: #4dabf7;
        color: white;
        box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
    }
    
    .form-label {
        color: rgba(255,255,255,0.9);
        font-weight: 500;
    }
    
    .form-text {
        color: rgba(255,255,255,0.7) !important;
    }
    
    .bg-light {
        background-color: rgba(255,255,255,0.1) !important;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .form-check-input:checked {
        background-color: #4dabf7;
        border-color: #4dabf7;
    }
    
    .info-card {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .info-card h6 {
        color: white;
        margin-bottom: 0.25rem;
    }
    
    .security-tips ul li {
        color: rgba(255,255,255,0.8);
        font-size: 0.9rem;
    }
    
    /* Password strength meter */
    .strength-meter {
        height: 5px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 3px;
    }
    
    .strength-weak { background: #f44336; width: 25%; }
    .strength-fair { background: #ff9800; width: 50%; }
    .strength-good { background: #2196f3; width: 75%; }
    .strength-strong { background: #4caf50; width: 100%; }
    
    .alert {
        background: rgba(77, 171, 247, 0.1);
        border: 1px solid rgba(77, 171, 247, 0.3);
        color: rgba(255, 255, 255, 0.9);
    }
    
    .alert-warning {
        background: rgba(255, 193, 7, 0.1);
        border-color: rgba(255, 193, 7, 0.3);
    }
    
    .alert-success {
        background: rgba(40, 167, 69, 0.1);
        border-color: rgba(40, 167, 69, 0.3);
    }
    
    @media (max-width: 768px) {
        .nav-pills .nav-link {
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        .avatar-frame img,
        .avatar-frame div {
            width: 120px !important;
            height: 120px !important;
        }
        
        .btn-group-vertical .btn {
            margin-bottom: 0.5rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password strength checker
    const passwordInput = document.getElementById('{{ password_form.new_password1.id_for_label }}');
    const confirmInput = document.getElementById('{{ password_form.new_password2.id_for_label }}');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    if (passwordInput && strengthFill && strengthText) {
        function checkPasswordStrength(password) {
            let score = 0;
            let feedback = 'Too short';
            
            if (password.length >= 8) score += 25;
            if (password.length >= 12) score += 25;
            if (/[a-z]/.test(password)) score += 10;
            if (/[A-Z]/.test(password)) score += 15;
            if (/[0-9]/.test(password)) score += 15;
            if (/[^A-Za-z0-9]/.test(password)) score += 10;
            
            strengthFill.className = 'strength-fill';
            
            if (score < 30) {
                strengthFill.classList.add('strength-weak');
                feedback = 'Weak';
            } else if (score < 60) {
                strengthFill.classList.add('strength-fair');
                feedback = 'Fair';
            } else if (score < 90) {
                strengthFill.classList.add('strength-good');
                feedback = 'Good';
            } else {
                strengthFill.classList.add('strength-strong');
                feedback = 'Strong';
            }
            
            strengthText.textContent = `Password strength: ${feedback}`;
        }
        
        passwordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            
            if (confirmInput && confirmInput.value && this.value !== confirmInput.value) {
                confirmInput.style.borderColor = '#f44336';
            } else if (confirmInput && confirmInput.value) {
                confirmInput.style.borderColor = '#4caf50';
            }
        });
        
        if (confirmInput) {
            confirmInput.addEventListener('input', function() {
                if (passwordInput.value !== this.value) {
                    this.style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '#4caf50';
                }
            });
        }
    }
    
    // Master notification toggle
    const masterToggle = document.getElementById('emailNotifications');
    const subToggles = ['weatherAlerts', 'dailySummary', 'severeWeatherAlerts'];
    
    if (masterToggle) {
        masterToggle.addEventListener('change', function() {
            subToggles.forEach(id => {
                const toggle = document.getElementById(id);
                if (toggle) {
                    toggle.disabled = !this.checked;
                    if (!this.checked) {
                        toggle.checked = false;
                    }
                }
            });
        });
        
        // Initial state
        if (!masterToggle.checked) {
            subToggles.forEach(id => {
                const toggle = document.getElementById(id);
                if (toggle) {
                    toggle.disabled = true;
                }
            });
        }
    }
    
    // Form validation
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            const password1 = passwordInput ? passwordInput.value : '';
            const password2 = confirmInput ? confirmInput.value : '';
            
            if (password1 !== password2) {
                e.preventDefault();
                alert('Passwords do not match!');
                if (confirmInput) confirmInput.focus();
            }
        });
    }
});
</script>
{% endblock %}